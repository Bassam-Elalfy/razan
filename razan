from flask import Flask, render_template_string, request, redirect, url_for, send_file
from fpdf import FPDF
import io
from datetime import datetime, timedelta

app = Flask(_name_)

# ----------------------------
# بيانات مبدئية للطلبة
# ----------------------------
students = {
    "1001": {
        "name": "Ahmed Ali",
        "subscription_end": datetime.now() + timedelta(days=30),
        "attendance": [],
        "homework": [],
        "videos_watched": 0,
    },
    "1002": {
        "name": "Sara Mohamed",
        "subscription_end": datetime.now() + timedelta(days=15),
        "attendance": [],
        "homework": [],
        "videos_watched": 3,
    }
}

# ----------------------------
# الصفحة الرئيسية
# ----------------------------
@app.route("/")
def index():
    return render_template_string("""
    <h1>📚 نظام إدارة الطلاب</h1>
    <a href="{{ url_for('students_list') }}">عرض قائمة الطلاب</a>
    """)

# ----------------------------
# قائمة الطلاب
# ----------------------------
@app.route("/students")
def students_list():
    return render_template_string("""
    <h1>👩‍🎓 قائمة الطلاب</h1>
    <ul>
    {% for sid, data in students.items() %}
        <li>
            {{ data['name'] }} (ID: {{ sid }}) - 
            الاشتراك ينتهي: {{ data['subscription_end'].strftime('%Y-%m-%d') }}
            | <a href="{{ url_for('student_detail', student_id=sid) }}">تفاصيل</a>
            | <a href="{{ url_for('download_report', student_id=sid) }}">📄 تقرير PDF</a>
        </li>
    {% endfor %}
    </ul>
    <a href="{{ url_for('index') }}">⬅ رجوع</a>
    """, students=students)

# ----------------------------
# تفاصيل الطالب
# ----------------------------
@app.route("/student/<student_id>")
def student_detail(student_id):
    student = students.get(student_id)
    if not student:
        return "❌ الطالب غير موجود"
    return render_template_string("""
    <h1>تفاصيل {{ student['name'] }}</h1>
    <p>ID: {{ student_id }}</p>
    <p>انتهاء الاشتراك: {{ student['subscription_end'].strftime('%Y-%m-%d') }}</p>
    <p>الحضور: {{ student['attendance'] }}</p>
    <p>الواجبات: {{ student['homework'] }}</p>
    <p>الفيديوهات المشاهدة: {{ student['videos_watched'] }}</p>

    <h3>تحديث البيانات:</h3>
    <form method="post" action="{{ url_for('mark_attendance', student_id=student_id) }}">
        <button type="submit">✅ إثبات حضور</button>
    </form>
    <form method="post" action="{{ url_for('add_homework', student_id=student_id) }}">
        <input type="text" name="task" placeholder="اسم الواجب">
        <button type="submit">➕ إضافة واجب</button>
    </form>
    <form method="post" action="{{ url_for('watch_video', student_id=student_id) }}">
        <button type="submit">▶ إضافة مشاهدة فيديو</button>
    </form>
    <form method="post" action="{{ url_for('extend_subscription', student_id=student_id) }}">
        <input type="number" name="days" placeholder="عدد الأيام">
        <button type="submit">📅 تمديد الاشتراك</button>
    </form>
    <br>
    <a href="{{ url_for('students_list') }}">⬅ رجوع</a>
    """, student=student, student_id=student_id)

# ----------------------------
# تحديثات الطالب
# ----------------------------
@app.route("/student/<student_id>/attendance", methods=["POST"])
def mark_attendance(student_id):
    student = students.get(student_id)
    if student:
        student["attendance"].append(datetime.now().strftime("%Y-%m-%d %H:%M"))
    return redirect(url_for("student_detail", student_id=student_id))

@app.route("/student/<student_id>/homework", methods=["POST"])
def add_homework(student_id):
    student = students.get(student_id)
    if student:
        task = request.form.get("task")
        if task:
            student["homework"].append({"task": task, "done": False})
    return redirect(url_for("student_detail", student_id=student_id))

@app.route("/student/<student_id>/video", methods=["POST"])
def watch_video(student_id):
    student = students.get(student_id)
    if student:
        student["videos_watched"] += 1
    return redirect(url_for("student_detail", student_id=student_id))

@app.route("/student/<student_id>/extend", methods=["POST"])
def extend_subscription(student_id):
    student = students.get(student_id)
    if student:
        days = int(request.form.get("days", 0))
        student["subscription_end"] += timedelta(days=days)
    return redirect(url_for("student_detail", student_id=student_id))

# ----------------------------
# تقرير PDF
# ----------------------------
@app.route("/student/<student_id>/report")
def download_report(student_id):
    student = students.get(student_id)
    if not student:
        return "❌ الطالب غير موجود"

    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=14)
    pdf.cell(200, 10, txt=f"تقرير الطالب - {student['name']}", ln=True, align="C")
    pdf.ln(10)

    pdf.cell(200, 10, txt=f"ID: {student_id}", ln=True)
    pdf.cell(200, 10, txt=f"انتهاء الاشتراك: {student['subscription_end'].strftime('%Y-%m-%d')}", ln=True)
    pdf.cell(200, 10, txt=f"عدد مرات الحضور: {len(student['attendance'])}", ln=True)
    pdf.cell(200, 10, txt=f"عدد الواجبات: {len(student['homework'])}", ln=True)
    pdf.cell(200, 10, txt=f"الفيديوهات المشاهدة: {student['videos_watched']}", ln=True)

    buffer = io.BytesIO()
    pdf.output(buffer)
    buffer.seek(0)

    return send_file(buffer, as_attachment=True, download_name=f"report_{student_id}.pdf")

# ----------------------------
# تشغيل التطبيق
# ----------------------------
if _name_ == "_main_":
    app.run(debug=True)
