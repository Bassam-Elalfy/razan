from flask import Flask, render_template_string, request, redirect, url_for, send_file
from fpdf import FPDF
import io
from datetime import datetime, timedelta

app = Flask(_name_)

# ----------------------------
# Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ© Ù„Ù„Ø·Ù„Ø¨Ø©
# ----------------------------
students = {
    "1001": {
        "name": "Ahmed Ali",
        "subscription_end": datetime.now() + timedelta(days=30),
        "attendance": [],
        "homework": [],
        "videos_watched": 0,
    },
    "1002": {
        "name": "Sara Mohamed",
        "subscription_end": datetime.now() + timedelta(days=15),
        "attendance": [],
        "homework": [],
        "videos_watched": 3,
    }
}

# ----------------------------
# Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
# ----------------------------
@app.route("/")
def index():
    return render_template_string("""
    <h1>ğŸ“š Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
    <a href="{{ url_for('students_list') }}">Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</a>
    """)

# ----------------------------
# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
# ----------------------------
@app.route("/students")
def students_list():
    return render_template_string("""
    <h1>ğŸ‘©â€ğŸ“ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
    <ul>
    {% for sid, data in students.items() %}
        <li>
            {{ data['name'] }} (ID: {{ sid }}) - 
            Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙŠÙ†ØªÙ‡ÙŠ: {{ data['subscription_end'].strftime('%Y-%m-%d') }}
            | <a href="{{ url_for('student_detail', student_id=sid) }}">ØªÙØ§ØµÙŠÙ„</a>
            | <a href="{{ url_for('download_report', student_id=sid) }}">ğŸ“„ ØªÙ‚Ø±ÙŠØ± PDF</a>
        </li>
    {% endfor %}
    </ul>
    <a href="{{ url_for('index') }}">â¬… Ø±Ø¬ÙˆØ¹</a>
    """, students=students)

# ----------------------------
# ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨
# ----------------------------
@app.route("/student/<student_id>")
def student_detail(student_id):
    student = students.get(student_id)
    if not student:
        return "âŒ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"
    return render_template_string("""
    <h1>ØªÙØ§ØµÙŠÙ„ {{ student['name'] }}</h1>
    <p>ID: {{ student_id }}</p>
    <p>Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {{ student['subscription_end'].strftime('%Y-%m-%d') }}</p>
    <p>Ø§Ù„Ø­Ø¶ÙˆØ±: {{ student['attendance'] }}</p>
    <p>Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª: {{ student['homework'] }}</p>
    <p>Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©: {{ student['videos_watched'] }}</p>

    <h3>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</h3>
    <form method="post" action="{{ url_for('mark_attendance', student_id=student_id) }}">
        <button type="submit">âœ… Ø¥Ø«Ø¨Ø§Øª Ø­Ø¶ÙˆØ±</button>
    </form>
    <form method="post" action="{{ url_for('add_homework', student_id=student_id) }}">
        <input type="text" name="task" placeholder="Ø§Ø³Ù… Ø§Ù„ÙˆØ§Ø¬Ø¨">
        <button type="submit">â• Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ø¬Ø¨</button>
    </form>
    <form method="post" action="{{ url_for('watch_video', student_id=student_id) }}">
        <button type="submit">â–¶ Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙŠØ¯ÙŠÙˆ</button>
    </form>
    <form method="post" action="{{ url_for('extend_subscription', student_id=student_id) }}">
        <input type="number" name="days" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…">
        <button type="submit">ğŸ“… ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</button>
    </form>
    <br>
    <a href="{{ url_for('students_list') }}">â¬… Ø±Ø¬ÙˆØ¹</a>
    """, student=student, student_id=student_id)

# ----------------------------
# ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
# ----------------------------
@app.route("/student/<student_id>/attendance", methods=["POST"])
def mark_attendance(student_id):
    student = students.get(student_id)
    if student:
        student["attendance"].append(datetime.now().strftime("%Y-%m-%d %H:%M"))
    return redirect(url_for("student_detail", student_id=student_id))

@app.route("/student/<student_id>/homework", methods=["POST"])
def add_homework(student_id):
    student = students.get(student_id)
    if student:
        task = request.form.get("task")
        if task:
            student["homework"].append({"task": task, "done": False})
    return redirect(url_for("student_detail", student_id=student_id))

@app.route("/student/<student_id>/video", methods=["POST"])
def watch_video(student_id):
    student = students.get(student_id)
    if student:
        student["videos_watched"] += 1
    return redirect(url_for("student_detail", student_id=student_id))

@app.route("/student/<student_id>/extend", methods=["POST"])
def extend_subscription(student_id):
    student = students.get(student_id)
    if student:
        days = int(request.form.get("days", 0))
        student["subscription_end"] += timedelta(days=days)
    return redirect(url_for("student_detail", student_id=student_id))

# ----------------------------
# ØªÙ‚Ø±ÙŠØ± PDF
# ----------------------------
@app.route("/student/<student_id>/report")
def download_report(student_id):
    student = students.get(student_id)
    if not student:
        return "âŒ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"

    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=14)
    pdf.cell(200, 10, txt=f"ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø§Ù„Ø¨ - {student['name']}", ln=True, align="C")
    pdf.ln(10)

    pdf.cell(200, 10, txt=f"ID: {student_id}", ln=True)
    pdf.cell(200, 10, txt=f"Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ: {student['subscription_end'].strftime('%Y-%m-%d')}", ln=True)
    pdf.cell(200, 10, txt=f"Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±: {len(student['attendance'])}", ln=True)
    pdf.cell(200, 10, txt=f"Ø¹Ø¯Ø¯ Ø§Ù„ÙˆØ§Ø¬Ø¨Ø§Øª: {len(student['homework'])}", ln=True)
    pdf.cell(200, 10, txt=f"Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©: {student['videos_watched']}", ln=True)

    buffer = io.BytesIO()
    pdf.output(buffer)
    buffer.seek(0)

    return send_file(buffer, as_attachment=True, download_name=f"report_{student_id}.pdf")

# ----------------------------
# ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
# ----------------------------
if _name_ == "_main_":
    app.run(debug=True)
